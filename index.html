<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Veo – Video Generation</title>
    <style>
      :root { --bg:#0b0c0f; --panel:#13151a; --muted:#9aa4ad; --fg:#e7eef7; --accent:#62a0ff; }
      *{box-sizing:border-box} body{
        margin:0; font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu;
        background:var(--bg); color:var(--fg);
      }
      .wrap{max-width:1024px;margin:40px auto;padding:0 20px}
      h1{font-weight:700; letter-spacing:.2px; margin:0 0 10px}
      .grid{display:grid; gap:16px; grid-template-columns: 1fr 360px}
      @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
      .card{background:var(--panel);border:1px solid #22262e;border-radius:16px;padding:16px}
      label{display:block;margin:12px 0 6px;color:var(--muted)}
      input[type=text], textarea, select{
        width:100%; background:#0e1116; border:1px solid #242933; color:var(--fg);
        padding:10px 12px; border-radius:10px; outline:none;
      }
      textarea{min-height:100px; resize:vertical}
      .row{display:flex; gap:12px}
      .row > *{flex:1}
      .btn{
        appearance:none; border:0; background:var(--accent); color:#08101c; font-weight:700;
        padding:12px 16px; border-radius:12px; cursor:pointer;
      }
      .btn[disabled]{opacity:.6; cursor:not-allowed}
      .pill{display:inline-flex; gap:8px}
      .meta{color:var(--muted); font-size:12px; margin-top:6px}
      video{width:100%; border-radius:12px; background:#000}
      .hr{height:1px;background:#1e2330;margin:12px 0}
      .radio{
        display:inline-flex;align-items:center; gap:8px; margin-right:12px; padding:6px 10px;
        background:#0e1116;border:1px solid #242933;border-radius:24px; cursor:pointer;
      }
      .radio input{appearance:none; width:10px; height:10px; border-radius:50%; border:2px solid var(--muted)}
      .radio input:checked{box-shadow:0 0 0 3px var(--accent) inset; border-color:var(--accent)}
      .note{font-size:12px;color:var(--muted)}
      .footer{margin-top:16px; display:flex; justify-content:space-between; align-items:center}
      .progress{font-size:13px; color:var(--muted)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Generate videos with Veo</h1>
      <div class="grid">
        <div class="card">
          <label>Describe your video</label>
          <textarea id="prompt" placeholder="e.g., Animate the subject to walk slowly toward the camera, gentle handheld motion, shallow depth."></textarea>

          <div class="row">
            <div>
              <label>Aspect ratio</label>
              <div class="pill">
                <label class="radio"><input type="radio" name="ar" value="16:9">16:9</label>
                <label class="radio"><input type="radio" name="ar" value="9:16" checked>9:16</label>
              </div>
            </div>
            <div>
              <label>Duration</label>
              <select id="duration">
                <option value="6">6s</option>
                <option value="8" selected>8s</option>
              </select>
            </div>
            <div>
              <label>Frame rate</label>
              <select id="fps">
                <option value="24" selected>24 fps</option>
              </select>
            </div>
            <div>
              <label>Resolution</label>
              <select id="res">
                <option value="720p" selected>720p</option>
              </select>
            </div>
          </div>

          <label>Negative prompt <span class="note">(optional)</span></label>
          <input id="neg" type="text" placeholder="blurry, low-detail, warped anatomy"/>

          <div class="hr"></div>

          <label>Conditioning image</label>
          <input id="file" type="file" accept="image/png,image/jpeg"/>

          <div class="footer">
            <button id="go" class="btn">Generate</button>
            <div id="progress" class="progress">Ready.</div>
          </div>
        </div>

        <div class="card">
          <video id="player" controls></video>
          <div class="meta" id="meta"></div>
        </div>
      </div>
    </div>

    <script type="module">
      const $ = (s) => document.querySelector(s);
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));

      const promptEl = $("#prompt");
      const negEl = $("#neg");
      const fileEl = $("#file");
      const goEl = $("#go");
      const player = $("#player");
      const progress = $("#progress");
      const meta = $("#meta");

      function getAspect() {
        const v = [...document.querySelectorAll("input[name='ar']")].find(x => x.checked)?.value;
        return v || "9:16";
      }

      async function readFileAsBase64(file) {
        const buf = await file.arrayBuffer();
        return btoa(String.fromCharCode(...new Uint8Array(buf)));
      }

      goEl.addEventListener("click", async () => {
        try {
          const file = fileEl.files?.[0];
          if (!file) { alert("Pick an image (PNG/JPG)"); return; }
          const imageBase64 = await readFileAsBase64(file);
          const imageMime = file.type || (file.name.endsWith(".png") ? "image/png" : "image/jpeg");

          const body = {
            prompt: promptEl.value?.trim() || "Subtle forward motion toward camera; gentle handheld; preserve subject identity.",
            aspectRatio: getAspect(),
            durationSec: $("#duration").value,
            fps: $("#fps").value,
            resolution: $("#res").value,
            negativePrompt: negEl.value?.trim(),
            imageBase64,
            imageMime
          };

          progress.textContent = "Starting generation…";
          goEl.disabled = true;

          // 1) Start
          const startRes = await fetch("/api/veo-start", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          const startData = await startRes.json();
          if (!startRes.ok) throw new Error(startData.error || "Failed to start");

          const opName = startData.operation?.name || startData.operation?.metadata?.name;
          if (!opName) throw new Error("Missing operation name");

          // 2) Poll
          let tries = 0;
          while (true) {
            await sleep(10000);
            tries++;
            progress.textContent = `Generating… (poll ${tries})`;
            const stRes = await fetch(`/api/veo-status?name=${encodeURIComponent(opName)}`);
            const stData = await stRes.json();
            if (!stRes.ok) throw new Error(stData.error || "Status error");
            if (stData.done) {
              progress.textContent = "Downloading video…";
              // 3) Stream MP4 via our proxy route
              const dlRes = await fetch(`/api/veo-download?name=${encodeURIComponent(opName)}`);
              if (!dlRes.ok) throw new Error("Download failed");
              const blob = await dlRes.blob();
              const url = URL.createObjectURL(blob);
              player.src = url;
              meta.textContent = `${(blob.size/1024/1024).toFixed(2)} MB • ${body.aspectRatio} • ${body.durationSec}s • ${body.resolution} • ${body.fps}fps`;
              progress.textContent = "Done.";
              goEl.disabled = false;
              break;
            }
          }
        } catch (err) {
          console.error(err);
          alert(err.message || "Something went wrong");
          progress.textContent = "Ready.";
          goEl.disabled = false;
        }
      });
    </script>
  </body>
</html>
