<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generate videos with Veo</title>
    <style>
      :root { --bg:#07090e; --panel:#13151a; --muted:#9aa4ad; --fg:#e7eef7; --accent:#62a0ff; }

      /* Full-screen animated aurora background */
      body {
        margin:0; font:14px/1.4 system-ui, Segoe UI, Roboto, Ubuntu;
        color:var(--fg); background:var(--bg); overflow-x:hidden;
      }
      body::before{
        content:""; position:fixed; inset:-20%; z-index:-2;
        background:
          radial-gradient(45% 30% at 20% 20%, rgba(98,160,255,.35), transparent 60%),
          radial-gradient(40% 30% at 80% 30%, rgba(140,85,255,.28), transparent 60%),
          radial-gradient(35% 25% at 60% 80%, rgba(12,210,255,.22), transparent 60%),
          radial-gradient(30% 25% at 20% 80%, rgba(0,255,170,.18), transparent 60%);
        filter: blur(40px) saturate(120%);
        animation: drift 24s ease-in-out infinite alternate;
        pointer-events:none;
      }
      body::after{
        content:""; position:fixed; inset:0; z-index:-1;
        background:
          linear-gradient(to bottom, rgba(255,255,255,.06), rgba(255,255,255,0) 120px) no-repeat,
          repeating-linear-gradient(to right, rgba(255,255,255,.03) 0 1px, transparent 1px 80px),
          repeating-linear-gradient(to bottom, rgba(255,255,255,.03) 0 1px, transparent 1px 80px);
        mix-blend-mode: overlay; opacity:.5; pointer-events:none;
      }
      @keyframes drift{0%{transform:translate3d(-3%,-2%,0) scale(1.05) rotate(-1deg)}100%{transform:translate3d(3%,2%,0) scale(1.08) rotate(1deg)}}

      /* Layout */
      .wrap{max-width:1024px;margin:40px auto;padding:0 20px}
      h1{font-weight:800;letter-spacing:.2px;margin:0 0 16px}
      .grid{display:grid;gap:16px;grid-template-columns:1fr 420px}
      @media (max-width:980px){.grid{grid-template-columns:1fr}}
      .card{background:var(--panel);border:1px solid #22262e;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
      label{display:block;margin:12px 0 6px;color:var(--muted)}
      input[type=text], textarea, select{
        width:100%;background:#0e1116;border:1px solid #242933;color:var(--fg);
        padding:10px 12px;border-radius:10px;outline:none
      }
      textarea{min-height:100px;resize:vertical}
      .row{display:flex;gap:12px}.row>*{flex:1}
      .btn{appearance:none;border:0;background:var(--accent);color:#08101c;font-weight:700;
        padding:12px 16px;border-radius:12px;cursor:pointer;transition:transform .06s ease}
      .btn:hover{transform:translateY(-1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
      .pill{display:inline-flex;gap:8px;flex-wrap:wrap}
      .meta{color:var(--muted);font-size:12px;margin-top:6px}
      video{width:100%;border-radius:12px;background:#000}
      .hr{height:1px;background:#1e2330;margin:12px 0}
      .radio{display:inline-flex;align-items:center;gap:8px;margin-right:12px;padding:6px 10px;
        background:#0e1116;border:1px solid #242933;border-radius:24px;cursor:pointer}
      .radio input{appearance:none;width:10px;height:10px;border-radius:50%;border:2px solid var(--muted)}
      .radio input:checked{box-shadow:0 0 0 3px var(--accent) inset;border-color:var(--accent)}
      .note{font-size:12px;color:var(--muted)}
      .footer{margin-top:16px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
      .progress{font-size:13px;color:var(--muted)}
      .dl{appearance:none;border:1px solid #2a3442;background:#0e1116;color:#cfe2ff;border-radius:10px;padding:10px 12px;text-decoration:none}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Generate videos with Veo</h1>

      <div class="grid">
        <!-- Controls -->
        <div class="card">
          <label>Describe your video</label>
          <textarea id="prompt" placeholder="Animate the subject to walk slowly toward the camera; gentle handheld motion; shallow depth of field."></textarea>

          <div class="row">
            <div>
              <label>Aspect ratio</label>
              <div class="pill">
                <label class="radio"><input type="radio" name="ar" value="16:9">16:9</label>
                <label class="radio"><input type="radio" name="ar" value="9:16" checked>9:16</label>
              </div>
            </div>
            <div>
              <label>Duration</label>
              <select id="duration">
                <option value="6">6s</option>
                <option value="8" selected>8s</option>
              </select>
            </div>
            <div>
              <label>Frame rate</label>
              <select id="fps">
                <option value="24" selected>24 fps</option>
              </select>
            </div>
            <div>
              <label>Resolution</label>
              <select id="res">
                <option value="720p" selected>720p</option>
                <option value="1080p">1080p</option> <!-- added -->
              </select>
            </div>
          </div>

          <label>Negative prompt <span class="note">(optional)</span></label>
          <input id="neg" type="text" placeholder="blurry, low-detail, warped anatomy"/>

          <div class="hr"></div>

          <label>Conditioning image</label>
          <input id="file" type="file" accept="image/png,image/jpeg"/>

          <div class="footer">
            <button id="go" class="btn">Generate</button>
            <div class="progress" id="progress">Ready.</div>
          </div>
        </div>

        <!-- Preview -->
        <div class="card">
          <video id="player" controls></video>
          <div class="meta" id="meta"></div>
          <div style="margin-top:10px;display:flex;gap:10px">
            <a id="download" class="dl" href="#" download="veo-output.mp4" style="display:none">Download MP4</a>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      const $ = (s)=>document.querySelector(s);
      const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
      const promptEl = $("#prompt"), negEl = $("#neg"), fileEl = $("#file"), goEl = $("#go"),
            player = $("#player"), progress = $("#progress"), meta = $("#meta"), dl = $("#download");

      function getAspect(){ return [...document.querySelectorAll("input[name='ar']")].find(x=>x.checked)?.value || "9:16"; }
      async function readFileAsBase64(f){ const buf = await f.arrayBuffer(); return btoa(String.fromCharCode(...new Uint8Array(buf))); }

      goEl.addEventListener("click", async ()=>{
        try{
          const f = fileEl.files?.[0]; if(!f){ alert("Pick a PNG/JPG image"); return; }
          const imageBase64 = await readFileAsBase64(f);
          const imageMime = f.type || (f.name.toLowerCase().endsWith(".png")?"image/png":"image/jpeg");

          const body = {
            prompt: (promptEl.value||"").trim() || "Subtle forward motion toward camera; gentle handheld; preserve subject identity.",
            aspectRatio: getAspect(),
            durationSec: $("#duration").value,
            fps: $("#fps").value,
            resolution: $("#res").value,
            negativePrompt: (negEl.value||"").trim(),
            imageBase64, imageMime
          };

          goEl.disabled = true; progress.textContent = "Starting generation…"; dl.style.display="none";

          // 1) Start op
          const startRes = await fetch("/api/veo-start", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
          const startData = await startRes.json();
          if(!startRes.ok) throw new Error(startData.error || "Failed to start");
          const opName = startData.name;
          if(!opName) throw new Error("Missing operation name");

          // 2) Poll
          let tries = 0;
          while(true){
            await sleep(10_000);
            tries++; progress.textContent = `Generating… (poll ${tries})`;
            const stRes = await fetch(`/api/veo-status?name=${encodeURIComponent(opName)}`);
            const st = await stRes.json();
            if(!stRes.ok) throw new Error(st.error || "Status error");
            if(st.done){
              progress.textContent = "Downloading video…";
              // 3) Stream MP4
              const dlRes = await fetch(`/api/veo-download?name=${encodeURIComponent(opName)}`);
              if(!dlRes.ok) throw new Error("Download failed");
              const blob = await dlRes.blob();
              const url = URL.createObjectURL(blob);
              player.src = url;
              dl.href = url; dl.style.display="inline-block";
              meta.textContent = `${(blob.size/1024/1024).toFixed(2)} MB • ${body.aspectRatio} • ${body.durationSec}s • ${body.resolution} • ${body.fps}fps`;
              progress.textContent = "Done.";
              goEl.disabled = false;
              break;
            }
          }
        }catch(err){
          console.error(err);
          alert(err.message || "Something went wrong");
          progress.textContent = "Ready.";
          goEl.disabled = false;
        }
      });
    </script>
  </body>
</html>
